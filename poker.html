<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Simulator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .poker-table {
            background: #0d5016;
            width: 700px;
            height: 500px;
            border-radius: 50%;
            margin: 20px auto;
            position: relative;
            border: 8px solid #8B4513;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .community-cards {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 10px;
        }
        .card-display {
            background: white;
            width: 50px;
            height: 70px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            border: 2px solid #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .player {
            position: absolute;
            background: #6c757d;
            color: white;
            padding: 15px;
            border-radius: 15px;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .player.active {
            background: #ffc107;
            color: black;
            border: 3px solid #ff6b35;
        }
        .player-1 { top: 20px; left: 20px; }
        .player-2 { top: 20px; right: 20px; }
        .player-3 { bottom: 20px; right: 20px; }
        .player-4 { bottom: 20px; left: 20px; }
        .player-5 { top: 50%; left: 10px; transform: translateY(-50%); }
        .player-6 { top: 50%; right: 10px; transform: translateY(-50%); }
        .player-card {
            background: white;
            color: black;
            width: 30px;
            height: 40px;
            border-radius: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
            border: 1px solid #ccc;
        }
        .odds {
            margin-top: 8px;
            font-size: 11px;
        }
        .win { color: #28a745; font-weight: bold; }
        .tie { color: #17a2b8; font-weight: bold; }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <!-- Header -->
        <div class="bg-dark text-white py-3 shadow">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col">
                        <h1 class="h3 mb-0">
                            <i class="bi bi-play-circle-fill me-2"></i>
                            Poker Simulator
                        </h1>
                        <p class="mb-0 text-muted">Step-by-step simulation with live odds</p>
                    </div>
                    <div class="col-auto">
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="nextStep()">
                                <i class="bi bi-arrow-right me-1"></i>
                                Next Step
                            </button>
                            <button class="btn btn-outline-light" onclick="resetGame()">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                New Hand
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container py-4">
            <!-- Game Info -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="h4 text-primary mb-0" id="stepCount">0</div>
                                    <small class="text-muted">Steps Completed</small>
                                </div>
                                <div class="col-md-3">
                                    <div class="h4 text-success mb-0" id="nextAction">Deal Hands</div>
                                    <small class="text-muted">Next Action</small>
                                </div>
                                <div class="col-md-3">
                                    <div class="h4 text-info mb-0" id="currentPhase">Preflop</div>
                                    <small class="text-muted">Current Phase</small>
                                </div>
                                <div class="col-md-3">
                                    <div class="h4 text-warning mb-0" id="playerCount">4</div>
                                    <small class="text-muted">Players</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Poker Table -->
            <div class="row">
                <div class="col-12">
                    <div class="poker-table">
                        <div class="community-cards" id="community-cards"></div>
                        <div class="player player-1 active" id="player1">
                            <div>Player 1</div>
                            <div id="player1-cards"></div>
                            <div class="odds" id="player1-odds"></div>
                        </div>
                        <div class="player player-2" id="player2">
                            <div>Player 2</div>
                            <div id="player2-cards"></div>
                            <div class="odds" id="player2-odds"></div>
                        </div>
                        <div class="player player-3" id="player3">
                            <div>Player 3</div>
                            <div id="player3-cards"></div>
                            <div class="odds" id="player3-odds"></div>
                        </div>
                        <div class="player player-4" id="player4">
                            <div>Player 4</div>
                            <div id="player4-cards"></div>
                            <div class="odds" id="player4-odds"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            players: [[], [], [], []],
            board: [],
            phase: 'preflop',
            steps: 0,
            initialized: false
        };

        const suits = ['s', 'h', 'd', 'c'];
        const faces = ['2', '3', '4', '5', '6', '7', '8', '9', 'T', 'J', 'Q', 'K', 'A'];
        const suitSymbols = {'s': '♠', 'h': '♥', 'd': '♦', 'c': '♣'};

        function formatCard(card) {
            if (card.length !== 2) return card;
            const face = card[0].toUpperCase();
            const suit = card[1].toLowerCase();
            const suitSymbol = suitSymbols[suit];
            return `${face}${suitSymbol}`;
        }

        function generateRandomCard() {
            const face = faces[Math.floor(Math.random() * faces.length)];
            const suit = suits[Math.floor(Math.random() * suits.length)];
            return face + suit;
        }

        function generateRandomHand() {
            const usedCards = new Set();
            const hand = [];
            while (hand.length < 2) {
                const card = generateRandomCard();
                if (!usedCards.has(card)) {
                    usedCards.add(card);
                    hand.push(card);
                }
            }
            return hand;
        }

        function generateRandomBoard(phase) {
            const usedCards = new Set();
            
            // Add all player cards to used cards
            gameState.players.forEach(player => {
                player.forEach(card => usedCards.add(card));
            });
            
            const board = [];
            const cardsNeeded = phase === 'preflop' ? 0 : phase === 'flop' ? 3 : phase === 'turn' ? 4 : 5;
            
            while (board.length < cardsNeeded) {
                const card = generateRandomCard();
                if (!usedCards.has(card)) {
                    usedCards.add(card);
                    board.push(card);
                }
            }
            
            return board;
        }

        // This is the key function - calls your Python script directly!
        async function calculateOdds(hands, board) {
            try {
                const inputData = JSON.stringify({
                    hands: hands,
                    board: board,
                    num_sims: 1000
                });

                console.log('Calling Python script with:', inputData);

                // Use fetch to call a simple Python script via a local server
                // This is the simplest way to bridge frontend and your Python backend
                const response = await fetch('http://localhost:8000/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: inputData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Python result:', result);
                return result;
            } catch (error) {
                console.error('Error calling Python script:', error);
                
                // Fallback to simple mock data if Python script fails
                const numPlayers = hands.length;
                const winPercentages = hands.map(() => Math.random() * 100);
                const tiePercentages = hands.map(() => Math.random() * 20);
                
                const total = winPercentages.reduce((sum, val) => sum + val, 0);
                const normalizedWins = winPercentages.map(val => (val / total) * 100);
                const normalizedTies = tiePercentages.map(val => (val / total) * 100);
                
                return {
                    wins: normalizedWins.map(val => Math.floor(val * 10)),
                    ties: normalizedTies.map(val => Math.floor(val * 10)),
                    win_percentages: normalizedWins,
                    tie_percentages: normalizedTies
                };
            }
        }

        function updateDisplay() {
            // Update community cards
            const communityDiv = document.getElementById('community-cards');
            communityDiv.innerHTML = gameState.board.map(card => 
                `<div class="card-display">${formatCard(card)}</div>`
            ).join('');

            // Update player cards and odds
            for (let i = 0; i < 4; i++) {
                const playerDiv = document.getElementById(`player${i+1}-cards`);
                const oddsDiv = document.getElementById(`player${i+1}-odds`);
                
                if (gameState.players[i].length > 0) {
                    playerDiv.innerHTML = gameState.players[i].map(card => 
                        `<div class="player-card">${formatCard(card)}</div>`
                    ).join('');
                } else {
                    playerDiv.innerHTML = '';
                }
                oddsDiv.innerHTML = '';
            }

            // Update game info
            document.getElementById('stepCount').textContent = gameState.steps;
            document.getElementById('currentPhase').textContent = gameState.phase;
            
            if (!gameState.initialized) {
                document.getElementById('nextAction').textContent = 'Deal Hands';
            } else if (gameState.phase === 'preflop') {
                document.getElementById('nextAction').textContent = 'Deal Flop';
            } else if (gameState.phase === 'flop') {
                document.getElementById('nextAction').textContent = 'Deal Turn';
            } else if (gameState.phase === 'turn') {
                document.getElementById('nextAction').textContent = 'Deal River';
            } else {
                document.getElementById('nextAction').textContent = 'New Hand';
            }
        }

        async function nextStep() {
            if (!gameState.initialized) {
                // Deal initial hands
                gameState.players = [];
                for (let i = 0; i < 4; i++) {
                    gameState.players.push(generateRandomHand());
                }
                gameState.initialized = true;
                gameState.steps++;
                
                // Calculate preflop odds
                const odds = await calculateOdds(gameState.players, []);
                updateOddsDisplay(odds);
                updateDisplay();
            } else if (gameState.phase === 'preflop') {
                // Deal flop
                gameState.board = generateRandomBoard('flop');
                gameState.phase = 'flop';
                gameState.steps++;
                
                // Calculate flop odds
                const odds = await calculateOdds(gameState.players, gameState.board);
                updateOddsDisplay(odds);
                updateDisplay();
            } else if (gameState.phase === 'flop') {
                // Deal turn
                const newCard = generateRandomBoard('turn').slice(-1)[0];
                gameState.board.push(newCard);
                gameState.phase = 'turn';
                gameState.steps++;
                
                // Calculate turn odds
                const odds = await calculateOdds(gameState.players, gameState.board);
                updateOddsDisplay(odds);
                updateDisplay();
            } else if (gameState.phase === 'turn') {
                // Deal river
                const newCard = generateRandomBoard('river').slice(-1)[0];
                gameState.board.push(newCard);
                gameState.phase = 'river';
                gameState.steps++;
                
                // Calculate river odds
                const odds = await calculateOdds(gameState.players, gameState.board);
                updateOddsDisplay(odds);
                updateDisplay();
            } else {
                // Reset for new hand
                resetGame();
            }
        }

        function updateOddsDisplay(odds) {
            for (let i = 0; i < 4; i++) {
                const oddsDiv = document.getElementById(`player${i+1}-odds`);
                if (odds && odds.win_percentages && odds.win_percentages[i] !== undefined) {
                    oddsDiv.innerHTML = `
                        <div class="win">Win: ${odds.win_percentages[i].toFixed(1)}%</div>
                        <div class="tie">Tie: ${odds.tie_percentages[i].toFixed(1)}%</div>
                    `;
                }
            }
        }

        function resetGame() {
            gameState = {
                players: [[], [], [], []],
                board: [],
                phase: 'preflop',
                steps: 0,
                initialized: false
            };
            updateDisplay();
        }

        // Initialize
        updateDisplay();
    </script>
</body>
</html>

