<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Simulator - Direct Python</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .poker-table {
            background: #0d5016;
            width: 700px;
            height: 500px;
            border-radius: 50%;
            margin: 20px auto;
            position: relative;
            border: 8px solid #8B4513;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .community-cards {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 10px;
        }
        .card-display {
            background: white;
            width: 50px;
            height: 70px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            border: 2px solid #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .card-red {
            color: #dc3545;
        }
        .card-black {
            color: #000;
        }
        .player {
            position: absolute;
            background: #6c757d;
            color: white;
            padding: 15px;
            border-radius: 15px;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .player.active {
            background: #ffc107;
            color: black;
            border: 3px solid #ff6b35;
        }
        .player-1 { top: 20px; left: 20px; }
        .player-2 { top: 20px; right: 20px; }
        .player-3 { bottom: 20px; right: 20px; }
        .player-4 { bottom: 20px; left: 20px; }
        .player-card {
            background: white;
            width: 30px;
            height: 40px;
            border-radius: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
            border: 1px solid #ccc;
        }
        .player-card.card-red {
            color: #dc3545;
        }
        .player-card.card-black {
            color: #000;
        }
        
        /* Card dealing animations */
        @keyframes cardDeal {
            0% {
                transform: translateY(-100px) rotate(-10deg);
                opacity: 0;
            }
            50% {
                transform: translateY(-20px) rotate(5deg);
                opacity: 0.8;
            }
            100% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
        }
        
        .card-dealing {
            animation: cardDeal 0.6s ease-out;
        }
        
        .hand-ranking {
            font-size: 10px;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            margin-top: 3px;
            text-align: center;
            line-height: 1.2;
            max-width: 80px;
            word-wrap: break-word;
        }
        
        .hand-ranking.royal-flush {
            color: #ffd700;
            text-shadow: 0 0 5px #ffd700;
        }
        
        .hand-ranking.straight-flush {
            color: #ff6b6b;
            text-shadow: 0 0 3px #ff6b6b;
        }
        
        .hand-ranking.four-of-a-kind {
            color: #4ecdc4;
            text-shadow: 0 0 3px #4ecdc4;
        }
        
        .hand-ranking.full-house {
            color: #45b7d1;
        }
        
        .hand-ranking.flush {
            color: #96ceb4;
        }
        
        .hand-ranking.straight {
            color: #feca57;
        }
        
        .hand-ranking.three-of-a-kind {
            color: #ff9ff3;
        }
        
        .hand-ranking.two-pair {
            color: #54a0ff;
        }
        
        .hand-ranking.pair {
            color: #5f27cd;
        }
        
        .hand-ranking.high-card {
            color: #c7ecee;
        }
        
        /* Additional visual effects */
        .card-display:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .player-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .odds {
            transition: all 0.3s ease;
        }
        
        .odds:hover {
            transform: scale(1.05);
        }
        
        /* Pulse animation for winning hands */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .hand-ranking.royal-flush,
        .hand-ranking.straight-flush,
        .hand-ranking.four-of-a-kind {
            animation: pulse 2s infinite;
        }
        .odds {
            margin-top: 8px;
            font-size: 11px;
            line-height: 1.3;
            min-height: 40px;
        }
        .win { 
            color: #28a745; 
            font-weight: bold; 
            margin-bottom: 2px;
            display: block;
        }
        .tie { 
            color: #17a2b8; 
            font-weight: bold; 
            margin-bottom: 2px;
            display: block;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <!-- Header -->
        <div class="bg-dark text-white py-3 shadow">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col">
                        <h1 class="h3 mb-0">
                            <i class="bi bi-play-circle-fill me-2"></i>
                            ALL IN SIM
                        </h1>
                        <p class="mb-0 text-muted">Step-by-step poker simulation with live odds</p>
                    </div>
                    <div class="col-auto">
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="nextStep()">
                                <i class="bi bi-arrow-right me-1"></i>
                                Next Step
                            </button>
                            <button class="btn btn-outline-light" onclick="resetGame()">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                New Hand
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container py-4">
            <!-- Game Info -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="h4 text-primary mb-0" id="stepCount">0</div>
                                    <small class="text-muted">Steps Completed</small>
                                </div>
                                <div class="col-md-3">
                                    <div class="h4 text-success mb-0" id="nextAction">Deal Hands</div>
                                    <small class="text-muted">Next Action</small>
                                </div>
                                <div class="col-md-3">
                                    <div class="h4 text-info mb-0" id="currentPhase">Preflop</div>
                                    <small class="text-muted">Current Phase</small>
                                </div>
                                <div class="col-md-3">
                                    <div class="h4 text-warning mb-0" id="playerCount">4</div>
                                    <small class="text-muted">Players</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Poker Table -->
            <div class="row">
                <div class="col-12">
                    <div class="poker-table">
                        <div class="community-cards" id="community-cards"></div>
                        <div class="player player-1 active" id="player1">
                            <div>Player 1</div>
                            <div id="player1-cards"></div>
                            <div class="odds" id="player1-odds"></div>
                        </div>
                        <div class="player player-2" id="player2">
                            <div>Player 2</div>
                            <div id="player2-cards"></div>
                            <div class="odds" id="player2-odds"></div>
                        </div>
                        <div class="player player-3" id="player3">
                            <div>Player 3</div>
                            <div id="player3-cards"></div>
                            <div class="odds" id="player3-odds"></div>
                        </div>
                        <div class="player player-4" id="player4">
                            <div>Player 4</div>
                            <div id="player4-cards"></div>
                            <div class="odds" id="player4-odds"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            players: [[], [], [], []],
            board: [],
            phase: 'preflop',
            steps: 0,
            initialized: false
        };
        
        // Store current hand rankings globally
        window.currentHandRankings = [];

        const suits = ['s', 'h', 'd', 'c'];
        const faces = ['2', '3', '4', '5', '6', '7', '8', '9', 'T', 'J', 'Q', 'K', 'A'];
        const suitSymbols = {'s': 'â™ ', 'h': 'â™¥', 'd': 'â™¦', 'c': 'â™£'};

        function formatCard(card) {
            if (card.length !== 2) return { symbol: card, className: 'card-black' };
            const face = card[0].toUpperCase();
            const suit = card[1].toLowerCase();
            const suitSymbol = suitSymbols[suit];
            const isRed = suit === 'h' || suit === 'd';
            return { 
                symbol: `${face}${suitSymbol}`, 
                className: isRed ? 'card-red' : 'card-black' 
            };
        }

        function generateRandomCard() {
            const face = faces[Math.floor(Math.random() * faces.length)];
            const suit = suits[Math.floor(Math.random() * suits.length)];
            return face + suit;
        }

        function generateRandomHand(usedCards) {
            const hand = [];
            while (hand.length < 2) {
                const card = generateRandomCard();
                if (!usedCards.has(card)) {
                    usedCards.add(card);
                    hand.push(card);
                }
            }
            return hand;
        }

        function generateRandomBoard(phase, usedCards) {
            const board = [];
            const cardsNeeded = phase === 'preflop' ? 0 : phase === 'flop' ? 3 : phase === 'turn' ? 4 : 5;
            
            while (board.length < cardsNeeded) {
                const card = generateRandomCard();
                if (!usedCards.has(card)) {
                    usedCards.add(card);
                    board.push(card);
                }
            }
            
            return board;
        }

        // This calls your Python script directly - SIMPLEST way!
        async function calculateOdds(hands, board) {
            try {
                const inputData = JSON.stringify({
                    hands: hands,
                    board: board,
                    num_sims: 1000
                });

                console.log('ðŸ Calling your pokersim.py with:', inputData);

                // Use Node.js to call your Python script
                const response = await fetch('/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: inputData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('âœ… Python result:', result);
                return result;
            } catch (error) {
                console.error('âŒ Error calling Python script:', error);
                
                // Fallback to simple mock data if Python script fails
                const numPlayers = hands.length;
                const winPercentages = hands.map(() => Math.random() * 100);
                const tiePercentages = hands.map(() => Math.random() * 20);
                
                const total = winPercentages.reduce((sum, val) => sum + val, 0);
                const normalizedWins = winPercentages.map(val => (val / total) * 100);
                const normalizedTies = tiePercentages.map(val => (val / total) * 100);
                
                return {
                    wins: normalizedWins.map(val => Math.floor(val * 10)),
                    ties: normalizedTies.map(val => Math.floor(val * 10)),
                    win_percentages: normalizedWins,
                    tie_percentages: normalizedTies
                };
            }
        }

        function updateDisplay() {
            // Update community cards with animation
            const communityDiv = document.getElementById('community-cards');
            communityDiv.innerHTML = gameState.board.map(card => {
                const cardData = formatCard(card);
                return `<div class="card-display ${cardData.className} card-dealing">${cardData.symbol}</div>`;
            }).join('');

            // Update player cards WITHOUT animation (but don't clear odds here)
            for (let i = 0; i < 4; i++) {
                const playerDiv = document.getElementById(`player${i+1}-cards`);
                
                if (gameState.players[i].length > 0) {
                    playerDiv.innerHTML = gameState.players[i].map(card => {
                        const cardData = formatCard(card);
                        return `<div class="player-card ${cardData.className}">${cardData.symbol}</div>`;
                    }).join('');
                } else {
                    playerDiv.innerHTML = '';
                }
                // Don't clear odds here - they should persist
            }

            // Update game info
            document.getElementById('stepCount').textContent = gameState.steps;
            document.getElementById('currentPhase').textContent = gameState.phase;
            
            if (!gameState.initialized) {
                document.getElementById('nextAction').textContent = 'Deal Hands';
            } else if (gameState.phase === 'preflop') {
                document.getElementById('nextAction').textContent = 'Deal Flop';
            } else if (gameState.phase === 'flop') {
                document.getElementById('nextAction').textContent = 'Deal Turn';
            } else if (gameState.phase === 'turn') {
                document.getElementById('nextAction').textContent = 'Deal River';
            } else {
                document.getElementById('nextAction').textContent = 'New Hand';
            }
        }

        async function nextStep() {
            if (!gameState.initialized) {
                // Deal initial hands
                const usedCards = new Set();
                gameState.players = [];
                for (let i = 0; i < 4; i++) {
                    gameState.players.push(generateRandomHand(usedCards));
                }
                gameState.initialized = true;
                gameState.steps++;
                
                // Calculate preflop odds using your Python script
                const odds = await calculateOdds(gameState.players, []);
                window.currentHandRankings = odds.hand_rankings || [];
                updateOddsDisplay(odds);
                updateDisplay();
            } else if (gameState.phase === 'preflop') {
                // Deal flop
                const usedCards = new Set();
                // Add all player cards to used cards
                gameState.players.forEach(player => {
                    player.forEach(card => usedCards.add(card));
                });
                gameState.board = generateRandomBoard('flop', usedCards);
                gameState.phase = 'flop';
                gameState.steps++;
                
                // Calculate flop odds using your Python script
                const odds = await calculateOdds(gameState.players, gameState.board);
                window.currentHandRankings = odds.hand_rankings || [];
                updateOddsDisplay(odds);
                updateDisplay();
            } else if (gameState.phase === 'flop') {
                // Deal turn
                const usedCards = new Set();
                // Add all player cards to used cards
                gameState.players.forEach(player => {
                    player.forEach(card => usedCards.add(card));
                });
                // Add existing board cards
                gameState.board.forEach(card => usedCards.add(card));
                
                const newCard = generateRandomBoard('turn', usedCards).slice(-1)[0];
                gameState.board.push(newCard);
                gameState.phase = 'turn';
                gameState.steps++;
                
                // Calculate turn odds using your Python script
                const odds = await calculateOdds(gameState.players, gameState.board);
                window.currentHandRankings = odds.hand_rankings || [];
                updateOddsDisplay(odds);
                updateDisplay();
            } else if (gameState.phase === 'turn') {
                // Deal river
                const usedCards = new Set();
                // Add all player cards to used cards
                gameState.players.forEach(player => {
                    player.forEach(card => usedCards.add(card));
                });
                // Add existing board cards
                gameState.board.forEach(card => usedCards.add(card));
                
                const newCard = generateRandomBoard('river', usedCards).slice(-1)[0];
                gameState.board.push(newCard);
                gameState.phase = 'river';
                gameState.steps++;
                
                // Calculate river odds using your Python script
                const odds = await calculateOdds(gameState.players, gameState.board);
                window.currentHandRankings = odds.hand_rankings || [];
                updateOddsDisplay(odds);
                updateDisplay();
            } else {
                // Reset for new hand
                resetGame();
            }
        }

        function updateOddsDisplay(odds) {
            console.log('Updating odds display with:', odds);
            for (let i = 0; i < 4; i++) {
                const oddsDiv = document.getElementById(`player${i+1}-odds`);
                if (odds && odds.win_percentages && odds.win_percentages[i] !== undefined) {
                    let handRankingHtml = '';
                    if (odds.hand_rankings && odds.hand_rankings[i]) {
                        const handRanking = odds.hand_rankings[i].toLowerCase().replace(/\s+/g, '-');
                        handRankingHtml = `<div class="hand-ranking ${handRanking}">${odds.hand_rankings[i]}</div>`;
                    }
                    
                    oddsDiv.innerHTML = `
                        <div class="win">Win: ${odds.win_percentages[i].toFixed(1)}%</div>
                        <div class="tie">Tie: ${odds.tie_percentages[i].toFixed(1)}%</div>
                        ${handRankingHtml}
                    `;
                    console.log(`Player ${i+1} odds: Win ${odds.win_percentages[i].toFixed(1)}%, Tie ${odds.tie_percentages[i].toFixed(1)}%`);
                } else {
                    oddsDiv.innerHTML = '';
                }
            }
        }

        function resetGame() {
            gameState = {
                players: [[], [], [], []],
                board: [],
                phase: 'preflop',
                steps: 0,
                initialized: false
            };
            updateDisplay();
        }

        // Initialize
        updateDisplay();
    </script>
</body>
</html>
